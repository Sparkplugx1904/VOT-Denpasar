name: Record and Transcribe VOT

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *"   # Tiap hari jam 05:00 UTC (~13:00 WITA)

jobs:
  record:
    name: ðŸŽ™ï¸ Record Stream and Upload
    runs-on: ubuntu-latest
    strategy:
      matrix:
        suffix: ["-s 4 -p 4"]
        # suffix: ["-s 4 -p 4", "-s 5 -p 5", "-s 6 -p 6"]
    outputs:
      url_s4p4: ${{ steps.map.outputs.url_s4p4 }}
      id_s4p4:  ${{ steps.map.outputs.id_s4p4 }}
      # url_s5p5: ${{ steps.map.outputs.url_s5p5 }}
      # id_s5p5:  ${{ steps.map.outputs.id_s5p5 }}
      # url_s6p6: ${{ steps.map.outputs.url_s6p6 }}
      # id_s6p6:  ${{ steps.map.outputs.id_s6p6 }}

    steps:
      - name: Download Python recorder & FFmpeg
        run: |
          curl -L -o record2.py https://raw.githubusercontent.com/Sparkplugx1904/voiceoftrisma/main/main/record2.py
          curl -L -o ffmpeg https://github.com/Sparkplugx1904/voiceoftrisma/raw/refs/heads/main/bin/ffmpeg
          curl -L -o ffprobe https://github.com/Sparkplugx1904/voiceoftrisma/raw/refs/heads/main/bin/ffprobe
          curl -L -o requirements.txt https://raw.githubusercontent.com/Sparkplugx1904/voiceoftrisma/main/requirements.txt
          chmod +x ffmpeg ffprobe

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run recorder (auto-export ENV)
        id: record
        env:
          MY_ACCESS_KEY: ${{ secrets.MY_ACCESS_KEY }}
          MY_SECRET_KEY: ${{ secrets.MY_SECRET_KEY }}
        run: |
          mkdir -p recordings
          python3 record2.py ${{ matrix.suffix }}

      - name: Map environment vars to matrix outputs
        id: map
        run: |
          echo "[ INFO ] Global env values:"
          echo "  ARCHIVE_URL: $ARCHIVE_URL"
          echo "  ITEM_ID: $ITEM_ID"

          if [[ -z "$ARCHIVE_URL" || -z "$ITEM_ID" ]]; then
            echo "[ ERROR ] Environment variables missing!"
            exit 1
          fi

          # Map ke matrix untuk lintas-job
          if [[ "${{ matrix.suffix }}" == "-s 4 -p 4" ]]; then
            echo "url_s4p4=$ARCHIVE_URL" >> $GITHUB_OUTPUT
            echo "id_s4p4=$ITEM_ID" >> $GITHUB_OUTPUT
          elif [[ "${{ matrix.suffix }}" == "-s 5 -p 5" ]]; then
            echo "url_s5p5=$ARCHIVE_URL" >> $GITHUB_OUTPUT
            echo "id_s5p5=$ITEM_ID" >> $GITHUB_OUTPUT
          elif [[ "${{ matrix.suffix }}" == "-s 6 -p 6" ]]; then
            echo "url_s6p6=$ARCHIVE_URL" >> $GITHUB_OUTPUT
            echo "id_s6p6=$ITEM_ID" >> $GITHUB_OUTPUT
          fi

          echo "[ OK ] Environment successfully mapped to job outputs."

          # Tunggu sebentar agar upload benar-benar tersinkron di archive.org
          sleep 300

  transcribe:
    name: ðŸ§  Transcribe and Push to Archive
    needs: record
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pair:
          - { suffix: "s4p4", url: "${{ needs.record.outputs.url_s4p4 }}", item: "${{ needs.record.outputs.id_s4p4 }}" }
          # - { suffix: "s5p5", url: "${{ needs.record.outputs.url_s5p5 }}", item: "${{ needs.record.outputs.id_s5p5 }}" }
          # - { suffix: "s6p6", url: "${{ needs.record.outputs.url_s6p6 }}", item: "${{ needs.record.outputs.id_s6p6 }}" }

    steps:
      - name: Clone Whisper-CPP (tanpa dotfiles)
        run: |
          git clone https://github.com/Sparkplugx1904/Whisper-CPP.git temp_whisper
          cd temp_whisper
          shopt -s extglob
          mv !(.?*) ../
          cd ..
          rm -rf temp_whisper

      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3      
      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3      
      - name: Setup FFmpeg
        uses: FedericoCarboni/setup-ffmpeg@v3      


      - name: Install dependencies
        run: pip install requests pydub internetarchive

      - name: Download audio file
        run: |
          echo "[ INFO ] Mengunduh audio dari ${{ matrix.pair.url }}"
          curl -L -o "audio_${{ matrix.pair.suffix }}.mp3" "${{ matrix.pair.url }}"

      - name: Transcribe audio
        run: |
          echo "[ INFO ] Transcribing audio_${{ matrix.pair.suffix }}.mp3..."
          python3 -u transcriptor_cpp.py "audio_${{ matrix.pair.suffix }}.mp3" medium

      - name: Upload transcript artifact
        uses: actions/upload-artifact@v4
        with:
          name: vot-transcript-${{ matrix.pair.suffix }}
          path: transcripts/

      - name: Push transcript to Archive.org
        env:
          MY_ACCESS_KEY: ${{ secrets.MY_ACCESS_KEY }}
          MY_SECRET_KEY: ${{ secrets.MY_SECRET_KEY }}
          ITEM_ID: ${{ matrix.pair.item }}
        run: |
          set -euo pipefail

          echo "[ INFO ] Upload transcript ke Archive.org item: $ITEM_ID"
          DETAILS_ARCHIVE_URL="https://archive.org/details/${ITEM_ID}/"
          echo "[ INFO ] DETAIL PAGE: ${DETAILS_ARCHIVE_URL}"

          if [ ! -d "transcripts" ]; then
            echo "[ ERROR ] Folder 'transcripts/' tidak ditemukan!"
            exit 1
          fi

          ia upload "${ITEM_ID}" transcripts/ --retries 3 \
            --metadata="subject:Transcription" \
            --metadata="description:Auto transcription added by GitHub Actions" \
            --access-key "$MY_ACCESS_KEY" --secret-key "$MY_SECRET_KEY"

          echo "[ DONE ] Upload transcripts complete!"
          echo "[ LINK ] Detail page: ${DETAILS_ARCHIVE_URL}"
