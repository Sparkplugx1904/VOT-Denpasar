name: Record and Transcribe VOT

on:
  workflow_dispatch:
  schedule:
    - cron: "0 5 * * *"   # Tiap hari jam 05:00 UTC (~13:00 WITA)

jobs:
  record:
    name: üéôÔ∏è Record Stream and Upload
    runs-on: ubuntu-latest
    strategy:
      matrix:
        suffix: ["-s 4 -p 4", "-s 5 -p 5", "-s 6 -p 6"]

    steps:
      - name: Download Python recorder & FFmpeg
        run: |
          curl -L -o record.py https://raw.githubusercontent.com/Sparkplugx1904/voiceoftrisma/main/main/record.py
          curl -L -o ffmpeg https://github.com/Sparkplugx1904/voiceoftrisma/raw/refs/heads/main/bin/ffmpeg
          curl -L -o ffprobe https://github.com/Sparkplugx1904/voiceoftrisma/raw/refs/heads/main/bin/ffprobe
          curl -L -o requirements.txt https://raw.githubusercontent.com/Sparkplugx1904/voiceoftrisma/main/requirements.txt
          chmod +x ffmpeg ffprobe

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run recorder
        env:
          MY_ACCESS_KEY: ${{ secrets.MY_ACCESS_KEY }}
          MY_SECRET_KEY: ${{ secrets.MY_SECRET_KEY }}
        run: |
          mkdir -p recordings
          python3 record.py ${{ matrix.suffix }}

      - name: Save archive URL (with fallback)
        run: |
          grep "https://archive.org/details/" <(cat recordings/* | strings) > archive_url.txt || echo "https://archive.org/details/UNKNOWN" > archive_url.txt

      # Buat nama artifact aman dari spasi
      - name: Prepare safe artifact name
        id: sanitize
        run: |
          safe_name=$(echo "${{ matrix.suffix }}" | tr ' ' '_')
          echo "safe_name=$safe_name" >> $GITHUB_ENV

      # Upload archive URL (retry 3x)
      - name: Upload archive URL
        run: |
          for i in {1..3}; do
            echo "[ Attempt $i ] Uploading archive URL..."
            gh run upload-artifact "archive-url-${{ env.safe_name }}" archive_url.txt && break || sleep 3
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload recording artifact (retry 3x)
      - name: Upload recording artifact
        run: |
          for i in {1..3}; do
            echo "[ Attempt $i ] Uploading recordings..."
            gh run upload-artifact "vot-recording-${{ env.safe_name }}" recordings/ && break || sleep 3
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  transcribe:
    name: üß† Transcribe and Push to Archive
    runs-on: ubuntu-latest
    needs: record

    steps:
      - name: Download all recording artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: vot-recording-*
          path: recordings/
          merge-multiple: true

      - name: Download all archive URL artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: archive-url-*
          path: .
          merge-multiple: true

      - name: Get archive URL variable
        id: get_url
        run: echo "archive_url=$(cat archive_url.txt)" >> $GITHUB_ENV

      - name: Clone Whisper-CPP (tanpa dotfiles)
        run: |
          git clone https://github.com/Sparkplugx1904/Whisper-CPP.git temp_whisper
          cd temp_whisper
          shopt -s extglob
          mv !(.?*) ../
          cd ..
          rm -rf temp_whisper

      - name: Setup FFmpeg (retry up to 3x)
        uses: FedericoCarboni/setup-ffmpeg@v3
        continue-on-error: true

      - name: Setup FFmpeg (retry 2)
        if: ${{ failure() }}
        uses: FedericoCarboni/setup-ffmpeg@v3
        continue-on-error: true

      - name: Setup FFmpeg (retry 3)
        if: ${{ failure() }}
        uses: FedericoCarboni/setup-ffmpeg@v3

      - name: Install dependencies
        run: pip install requests pydub internetarchive

      - name: Transcribe audio
        run: |
          audio_file=$(ls recordings/*.mp3 | head -n 1)
          echo "[ INFO ] Transcribing $audio_file..."
          python3 -u transcriptor_cpp.py "$audio_file" medium

      - name: Upload transcript artifact
        uses: actions/upload-artifact@v4
        with:
          name: vot-transcript
          path: transcripts/

      - name: Push transcript to Archive.org
        env:
          MY_ACCESS_KEY: ${{ secrets.MY_ACCESS_KEY }}
          MY_SECRET_KEY: ${{ secrets.MY_SECRET_KEY }}
          ARCHIVE_URL: ${{ env.archive_url }}
        run: |
          item_id=$(basename "$ARCHIVE_URL")
          echo "[ INFO ] Uploading transcript to $ARCHIVE_URL..."
          ia upload "$item_id" transcripts/ --retries 3 \
            --metadata="subject:Transcription" \
            --metadata="description:Auto transcription added by GitHub Actions" \
            --access-key "$MY_ACCESS_KEY" --secret-key "$MY_SECRET_KEY"
