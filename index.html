<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pustaka Rekaman VOT Denpasar</title>
  <link rel="icon" type="image/png" href="https://madyapadma-online.com/images/icon/madyapadma.png">
  
  <!-- Bootstrap & Font -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,700&display=swap" rel="stylesheet">
  
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #f5f5f5;
    }
    /* Header */
    #sp-header {
      background-color: #444;
      padding: 10px 0;
    }
    #sp-header .logo img {
      height: 50px;
    }
    .navbar-nav > li > a {
      color: #fff !important;
      font-weight: 600;
    }
    .navbar-nav > li > a:hover {
      color: #00b9d8 !important;
    }

    /* Toolbar */
    .toolbar {
      margin: 20px 0;
    }
    .search-box {
      display: flex;
      gap: 8px;
    }
    .search-box input {
      flex: 1;
    }

    /* List */
    .list-group-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .list-meta {
      flex: 1;
      margin-left: 12px;
    }
    .list-meta .title {
      font-weight: 600;
    }
    .badge-id {
      background: #00b9d8;
      color: #fff;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
    }

    /* Player */
    .player {
      /* margin-top: 20px; */ /* Hapus margin-top agar tidak ada gap */
      padding: 15px;
      background: #fff;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header id="sp-header">
    <div class="container">
      <div class="row">
        <div class="col-sm-3">
          <a class="logo" href="https://madyapadma-online.com/">
            <img src="https://madyapadma-online.com/images/logo-madya-padma.png" alt="Madyapadma Journalistic Park">
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Content -->
  <div class="container">
    <div class="toolbar row">
      <div class="col-sm-8">
        <div class="input-group search-box">
          <span class="input-group-addon"><i class="fa fa-search"></i></span>
          <input id="q" type="text" class="form-control" placeholder="Cari tanggal atau ID… (mis. 29-08-25)">
        </div>
      </div>
      <div class="col-sm-4 text-right">
        <button class="btn btn-default" id="sortBtn">Urut: Terbaru</button>
        <button class="btn btn-primary" id="refreshBtn">Muat Ulang</button>
      </div>
    </div>

    <div id="list" class="list-group"></div>

  </div>

  <!-- Scripts -->
  <script>
    function getIdentifierFromDetailsUrl(url){
      try{
        const u = new URL(url);
        const parts = u.pathname.split('/').filter(Boolean);
        const idx = parts.indexOf('details');
        if(idx !== -1 && parts[idx+1]) return parts[idx+1];
      }catch(e){}
      return null;
    }

    async function resolveMp3Url(identifier){
      const metaUrl = `https://archive.org/metadata/${identifier}`;
      const res = await fetch(metaUrl);
      if(!res.ok) throw new Error('Gagal ambil metadata');
      const meta = await res.json();
      const files = meta.files || [];
      const candidate = files.find(f => (f.format||'').toLowerCase().includes('mp3'))
                      || files.find(f => (f.name||'').toLowerCase().endsWith('.mp3'));
      if(!candidate) return null;
      return `https://archive.org/download/${identifier}/${encodeURIComponent(candidate.name)}`;
    }

    const state = { data: [], sortDesc: true };
    const listEl = document.getElementById('list');

    // Buat playerEl secara dinamis
    const playerEl = document.createElement('div');
    playerEl.className = 'player';
    playerEl.id = 'player';
    playerEl.hidden = true;
    playerEl.innerHTML = `
      <h4 id="nowTitle">—</h4>
      <p id="nowSub">Memuat pemutar…</p>
      <audio id="audio" controls preload="none" style="width:100%"></audio>
    `;
    // Ambil referensi elemen dalam player
    const audioEl = playerEl.querySelector('#audio');
    const nowTitle = playerEl.querySelector('#nowTitle');
    const nowSub = playerEl.querySelector('#nowSub');

    async function loadJson(){
      // Ganti URL ke recording.json lokal jika perlu, atau biarkan seperti sekarang
      const res = await fetch('https://raw.githubusercontent.com/Sparkplugx1904/VOT-Denpasar/refs/heads/main/recording.json', { cache: 'no-store' });
      if(!res.ok) throw new Error('Tidak dapat memuat recording.json');
      const json = await res.json();
      // Pastikan json adalah array sesuai format yang diberikan
      state.data = Array.isArray(json) ? json.slice() : [];
      render();
    }

    function render(){
      const q = document.getElementById('q').value.trim().toLowerCase();
      let items = state.data.slice();
      if(!state.sortDesc) items.reverse();
      if(q){
        // Filter berdasarkan tanggal atau url (ID)
        items = items.filter(it => (it.tanggal||'').toLowerCase().includes(q) || (it.url||'').toLowerCase().includes(q));
      }

      listEl.innerHTML = '';
      // Hapus player dari DOM setiap render
      if(playerEl.parentNode) playerEl.parentNode.removeChild(playerEl);
      playerEl.hidden = true;

      if(items.length === 0){
        listEl.innerHTML = `<div class="list-group-item text-center">Tidak ada rekaman atau tidak cocok dengan pencarian.</div>`;
        return;
      }

      for(const it of items){
        const id = getIdentifierFromDetailsUrl(it.url);
        const row = document.createElement('div');
        row.className = 'list-group-item';

        const meta = document.createElement('div');
        meta.className = 'list-meta';
        meta.innerHTML = `<div class="title">${it.title}-${it.tanggal}</div>`+
                 `<div><span class="badge-id">${id || ''}</span> <a href="${it.url}" target="_blank">Buka di Archive.org</a></div>`;

        const playBtn = document.createElement('button');
        playBtn.className = 'btn btn-success';
        playBtn.textContent = 'Putar';
        playBtn.onclick = async () => {
          // Hapus player dari DOM jika ada
          if(playerEl.parentNode) playerEl.parentNode.removeChild(playerEl);
          // Sisipkan player sebelum baris yang diputar
          row.parentNode.insertBefore(playerEl, row);
          playerEl.hidden = false;
          nowTitle.textContent = `${it.title}-${it.tanggal}`; // Format sesuai permintaan
          nowSub.textContent = id ? id : '—';
          audioEl.removeAttribute('src');
          audioEl.load();
          try{
            const mp3 = id ? await resolveMp3Url(id) : null;
            if(!mp3){
              nowSub.textContent = 'File MP3 tidak ditemukan di item';
              return;
            }
            audioEl.src = mp3;
            audioEl.play().catch(()=>{});
            nowSub.innerHTML = `<span>Memainkan: </span><code>${mp3.split('/').pop()}</code>`;
          }catch(err){
            nowSub.textContent = 'Gagal memuat audio: ' + err.message;
          }
        };

        row.appendChild(meta);
        row.appendChild(playBtn);
        listEl.appendChild(row);
      }
    }

    document.getElementById('q').addEventListener('input', render);
    document.getElementById('sortBtn').addEventListener('click', () => {
      state.sortDesc = !state.sortDesc;
      document.getElementById('sortBtn').textContent = 'Urut: ' + (state.sortDesc ? 'Terbaru' : 'Terlama');
      render();
    });
    document.getElementById('refreshBtn').addEventListener('click', () => loadJson());

    loadJson().catch(err => {
      listEl.innerHTML = `<div class="list-group-item text-center">${err.message}</div>`;
    });
  </script>
</body>
</html>



